# ルート詳細画面のテスト手順

## 📋 テスト前の準備

### 1. Supabase RPC関数の作成

`ROUTE_DETAIL_SETUP.md` の手順に従って、Supabase側にRPC関数を作成してください。

**重要**: この手順を完了しないと、ルート詳細画面は**デフォルト座標**を使用します。

### 2. 開発サーバーの確認

```bash
# サーバーが起動しているか確認
pm2 list

# ヘルスチェック
curl http://localhost:3000/api/health
```

### 3. テスト用ルートの確認

Supabaseダッシュボード → **Table Editor** → **routes** テーブルを開いて、保存済みルートがあることを確認します。

ルートIDをメモしておきます（例: `123e4567-e89b-12d3-a456-426614174000`）。

## 🧪 テスト手順

### テスト1: ホーム画面からのアクセス

1. **WanMapアプリを開く**
   - URL: https://3000-ifptz010rbeusa0fgwxvk-2b54fc91.sandbox.novita.ai

2. **ログインしているか確認**
   - 右上のユーザーアイコンが緑色 = ログイン済み
   - グレー = 未ログイン → ログインしてください

3. **ホーム画面でルートカードを探す**
   - ルートがない場合: 「記録」タブで新しいルートを作成

4. **ルートカードをクリック**
   - カード全体がクリック可能

### テスト2: ルート詳細画面の表示確認

#### 期待される動作

**ローディング表示**
- クリック後、緑色のスピナーが表示される
- 1-2秒後に詳細画面に切り替わる

**画面構成**
- ✅ 戻るボタン（左上）
- ✅ ルートタイトル
- ✅ 地図（高さ300px）
- ✅ ルート説明文
- ✅ 統計情報（距離、時間、難易度）
- ✅ アクションボタン（いいね、コメント、シェア）

**地図表示**
- ✅ OpenStreetMapが表示される
- ✅ 青色の経路線が描画される
- ✅ スタート地点に青いマーカー（クリックで「スタート地点」ポップアップ）
- ✅ ゴール地点に赤いマーカー（クリックで「ゴール地点」ポップアップ）
- ✅ 地図のズームレベルが経路全体が見えるように自動調整される

### テスト3: エラーハンドリング

#### 存在しないルートID

ブラウザのコンソールで実行：
```javascript
viewRouteDetail('00000000-0000-0000-0000-000000000000');
```

**期待される結果**:
```
ルートが見つかりませんでした
```

#### RPC関数が未作成の場合

コンソールに以下のメッセージが表示されます：
```
RPC関数が見つかりません。代替方法を使用します
```

**代替動作**:
- デフォルト座標（箱根）が表示される
- 地図は正常に動作する
- データベースのルート情報は表示される

### テスト4: 戻るボタン

1. ルート詳細画面で**戻るボタン（←）**をクリック
2. ホーム画面に戻ることを確認

### テスト5: いいねボタン（未実装）

**現在の動作**: クリックしても何も起こりません（Phase 2で実装予定）

### テスト6: レスポンシブデザイン

1. ブラウザの開発者ツールを開く（F12）
2. デバイスツールバーをクリック（Ctrl+Shift+M）
3. iPhone、iPad、Androidなど異なる画面サイズで表示確認

**期待される動作**:
- モバイル: 縦長画面で最適化
- タブレット: 中サイズ画面で最適化
- デスクトップ: 横長画面で最適化

## 🐛 トラブルシューティング

### 問題1: 地図が表示されない

**症状**: 地図エリアが白いまたはグレー

**原因**:
- `#detailMap` の高さ設定が欠落
- Leaflet.jsの初期化タイミングの問題

**解決策**:
1. ブラウザのコンソールを確認
2. `styles.css` の `#detailMap` スタイルを確認：
```css
#detailMap {
  width: 100%;
  height: calc(100vh - 128px);
  min-height: 400px;
}
```
3. ページをリロード（Ctrl+R）

### 問題2: 経路線が表示されない

**症状**: 地図は表示されるが、青い経路線が表示されない

**原因**:
- `path` データが正しく解析されていない
- GeoJSON変換エラー

**解決策**:
1. コンソールでエラーを確認
2. `parseGeoJSONCoordinates` 関数のログを確認：
```javascript
console.log('Parsed path:', route.path);
```
3. Supabase RPC関数が正しく作成されているか確認

### 問題3: スタート/ゴールマーカーが表示されない

**症状**: 経路線は表示されるが、マーカーがない

**原因**:
- `start_point` または `end_point` データが欠落
- GeoJSON変換エラー

**解決策**:
1. コンソールでルートデータを確認：
```javascript
console.log('Start point:', route.start_point);
console.log('End point:', route.end_point);
```
2. Supabase RPC関数を再度実行

### 問題4: 「ルートが見つかりませんでした」エラー

**症状**: 詳細画面に赤いエラーメッセージ

**原因**:
- ルートが削除された
- データベース接続エラー
- Row Level Security (RLS) ポリシーで拒否

**解決策**:
1. ルートIDが正しいか確認
2. Supabaseダッシュボードで routes テーブルを確認
3. RLSポリシーを確認（ログインしているか）

### 問題5: ローディングが終わらない

**症状**: 緑色のスピナーが永遠に回り続ける

**原因**:
- Supabase接続エラー
- API レスポンスのタイムアウト

**解決策**:
1. ネットワークタブ（F12 → Network）を確認
2. APIリクエストのステータスを確認
3. Supabase認証情報（.dev.vars）を確認

## 📊 テスト結果チェックリスト

### 基本機能
- [ ] ホーム画面からルートカードをクリックできる
- [ ] ルート詳細画面が表示される
- [ ] 戻るボタンでホーム画面に戻れる

### 地図表示
- [ ] OpenStreetMapが表示される
- [ ] 経路線（青色）が表示される
- [ ] スタート地点マーカー（青）が表示される
- [ ] ゴール地点マーカー（赤）が表示される
- [ ] 地図のズームレベルが適切

### ルート情報
- [ ] ルートタイトルが表示される
- [ ] 説明文が表示される
- [ ] 距離が正しく表示される（km単位）
- [ ] 時間が正しく表示される（分または時間）
- [ ] 難易度が表示される

### UI/UX
- [ ] ローディング中のスピナーが表示される
- [ ] レスポンシブデザインが機能する
- [ ] モバイルで適切に表示される
- [ ] タップ/クリックが反応する

### エラーハンドリング
- [ ] 存在しないルートIDで適切なエラーメッセージ
- [ ] RPC関数未作成でも代替動作する
- [ ] ネットワークエラー時に適切なメッセージ

## 🎯 テスト完了後

すべてのチェックリストが ✅ になったら：

1. **スクリーンショットを撮影**（成功の証明）
2. **次のタスクに進む**:
   - PWAアイコン生成
   - Cloudflare Pagesデプロイ
   - Phase 2機能の実装

---

**テスト担当**: 篤志さん  
**テスト日**: 2025-01-11  
**テスト環境**: Sandbox開発環境  
**テスト対象**: WanMap Phase 1 MVP - ルート詳細画面
